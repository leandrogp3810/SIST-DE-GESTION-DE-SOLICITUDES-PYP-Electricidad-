---
import Layout from '../layouts/Layout.astro';
---

<Layout title="P&P Electricidad - Iniciar Sesión">
	<div class="login-container">
		<div class="login-card">
			<div class="logo-container">
				<img src="/logo.png" alt="P&P Electricidad" class="logo" />
			</div>
			<div id="loginSection">
				<h1>Iniciar Sesión</h1>
				<form id="loginForm">
					<div class="form-group">
						<label for="username">Usuario</label>
						<input type="text" id="username" name="username" required />
					</div>
					<div class="form-group">
						<label for="password">Contraseña</label>
						<input type="password" id="password" name="password" required />
					</div>
					<button type="submit" class="btn btn-primary" style="width: 100%;">Ingresar</button>
					<div id="loginError" class="error-message"></div>
					<p class="auth-switch">
						¿No tienes cuenta? <a href="#" id="showRegister">Regístrate aquí</a>
					</p>
				</form>
			</div>

			<div id="registerSection" style="display: none;">
				<h1>Crear Cuenta</h1>
				<form id="registerForm">
					<div class="form-group">
						<label for="regUsername">Usuario</label>
						<input type="text" id="regUsername" name="username" required />
					</div>
					<div class="form-group">
						<label for="regPassword">Contraseña</label>
						<input type="password" id="regPassword" name="password" required />
					</div>
					<div class="form-group">
						<label for="regName">Nombre Completo</label>
						<input type="text" id="regName" name="name" required />
					</div>
					<div class="form-group">
						<label for="regEmail">Email</label>
						<input type="email" id="regEmail" name="email" required />
					</div>
					<div class="form-group">
						<label for="regPhone">Teléfono</label>
						<input type="tel" id="regPhone" name="phone" required />
					</div>
					<button type="submit" class="btn btn-primary" style="width: 100%;">Registrarse</button>
					<div id="registerError" class="error-message"></div>
					<div id="registerSuccess" class="success-message"></div>
					<p class="auth-switch">
						¿Ya tienes cuenta? <a href="#" id="showLogin">Inicia sesión</a>
					</p>
				</form>
			</div>
		</div>
	</div>
</Layout>

<style>
	.auth-switch {
		margin-top: 1.5rem;
		text-align: center;
		font-size: 0.9rem;
		color: var(--gray-600);
	}

	.auth-switch a {
		color: var(--primary-color);
		text-decoration: none;
		font-weight: 600;
	}

	.auth-switch a:hover {
		text-decoration: underline;
	}
</style>

<script>
	import { login, createUser } from '../stores/appStore';

	const loginForm = document.getElementById('loginForm') as HTMLFormElement;
	const loginError = document.getElementById('loginError') as HTMLDivElement;
	const registerForm = document.getElementById('registerForm') as HTMLFormElement;
	const registerError = document.getElementById('registerError') as HTMLDivElement;
	const registerSuccess = document.getElementById('registerSuccess') as HTMLDivElement;
	const loginSection = document.getElementById('loginSection') as HTMLDivElement;
	const registerSection = document.getElementById('registerSection') as HTMLDivElement;
	const showRegisterBtn = document.getElementById('showRegister') as HTMLAnchorElement;
	const showLoginBtn = document.getElementById('showLogin') as HTMLAnchorElement;

	// Toggle forms
	showRegisterBtn.addEventListener('click', (e) => {
		e.preventDefault();
		loginSection.style.display = 'none';
		registerSection.style.display = 'block';
		loginForm.reset();
		loginError.classList.remove('show');
	});

	showLoginBtn.addEventListener('click', (e) => {
		e.preventDefault();
		registerSection.style.display = 'none';
		loginSection.style.display = 'block';
		registerForm.reset();
		registerError.classList.remove('show');
		registerSuccess.classList.remove('show');
	});

	// Login logic
	loginForm.addEventListener('submit', (e) => {
		e.preventDefault();

		const formData = new FormData(loginForm);
		const username = formData.get('username') as string;
		const password = formData.get('password') as string;

		const user = login(username, password);

		if (user) {
			if (user.role === 'admin') {
				window.location.href = '/admin';
			} else {
				window.location.href = '/client';
			}
		} else {
			loginError.textContent = 'Usuario o contraseña incorrectos';
			loginError.classList.add('show');
			setTimeout(() => {
				loginError.classList.remove('show');
			}, 3000);
		}
	});

	// Register logic
	registerForm.addEventListener('submit', (e) => {
		e.preventDefault();

		const formData = new FormData(registerForm);
		const userData = {
			username: formData.get('username') as string,
			password: formData.get('password') as string,
			name: formData.get('name') as string,
			email: formData.get('email') as string,
			phone: formData.get('phone') as string
		};

		const result = createUser(userData);

		if (result.success) {
			registerSuccess.textContent = 'Cuenta creada exitosamente. Iniciando sesión...';
			registerSuccess.classList.add('show');
			registerError.classList.remove('show');

			// Auto login
			setTimeout(() => {
				login(userData.username, userData.password);
				window.location.href = '/client';
			}, 1500);
		} else {
			registerError.textContent = result.message;
			registerError.classList.add('show');
			registerSuccess.classList.remove('show');
			
			setTimeout(() => {
				registerError.classList.remove('show');
			}, 3000);
		}
	});
</script>
