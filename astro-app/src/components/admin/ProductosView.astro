<div id="productosView" class="view">
	<div class="header-actions">
		<h2>Gestión de Productos</h2>
		<button id="addProductBtn" class="btn btn-primary">
			+ Nuevo Producto
		</button>
	</div>

	<div id="productsList" class="products-grid">
		<!-- Products will be rendered here -->
	</div>
</div>

<!-- Product Modal -->
<div id="productModal" class="modal">
	<div class="modal-content">
		<div class="modal-header">
			<h2 id="modalTitle">Nuevo Producto</h2>
			<span class="close-modal">&times;</span>
		</div>
		<div class="modal-body">
			<form id="productForm">
				<input type="hidden" id="productId" name="id">
				
				<div class="form-group">
					<label for="prodName">Nombre del Producto*</label>
					<input type="text" id="prodName" name="name" required>
				</div>

				<div class="form-row">
					<div class="form-group">
						<label for="prodPrice">Precio*</label>
						<input type="number" id="prodPrice" name="price" min="0" step="0.01" required>
					</div>
					<div class="form-group">
						<label for="prodStock">Stock Inicial*</label>
						<input type="number" id="prodStock" name="stock" min="0" required>
					</div>
				</div>

				<div class="form-group">
					<label for="prodImages">Imágenes</label>
					<input type="file" id="prodImages" multiple accept="image/*">
					<div id="imagePreview" class="image-preview-grid"></div>
				</div>

				<div class="modal-footer">
					<button type="button" class="btn btn-secondary close-modal-btn">Cancelar</button>
					<button type="submit" class="btn btn-primary">Guardar Producto</button>
				</div>
			</form>
		</div>
	</div>
</div>

<style is:global>
	.header-actions {
		display: flex;
		justify-content: space-between;
		align-items: center;
		margin-bottom: 2rem;
	}

	.products-grid {
		display: grid;
		grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
		gap: 1.5rem;
	}

	.product-card {
		background: white;
		border-radius: 8px;
		overflow: hidden;
		box-shadow: 0 2px 4px rgba(0,0,0,0.1);
		border: 1px solid #eee;
		display: flex;
		flex-direction: column;
	}

	.product-image {
		height: 150px;
		width: 100%;
		object-fit: cover;
		background: #f8f9fa;
	}

	.product-details {
		padding: 1rem;
		flex: 1;
	}

	.product-details h3 {
		margin: 0 0 0.5rem 0;
		font-size: 1.1rem;
	}

	.product-meta {
		display: flex;
		justify-content: space-between;
		color: #666;
		font-size: 0.9rem;
		margin-bottom: 1rem;
	}

	.product-price {
		font-weight: bold;
		color: var(--primary-color);
	}

	.product-actions {
		padding: 1rem;
		background: #f8f9fa;
		border-top: 1px solid #eee;
		display: flex;
		gap: 0.5rem;
	}

	.image-preview-grid {
		display: flex;
		gap: 10px;
		flex-wrap: wrap;
		margin-top: 10px;
	}

	.preview-img {
		width: 60px;
		height: 60px;
		object-fit: cover;
		border-radius: 4px;
		border: 1px solid #ddd;
	}
</style>

<script>
	import { $products, addProduct, updateProduct, deleteProduct, type Product } from '../../stores/products';

	const productModal = document.getElementById('productModal');
	const productForm = document.getElementById('productForm') as HTMLFormElement;
	const modalTitle = document.getElementById('modalTitle');
	const imagePreview = document.getElementById('imagePreview');
	const addProductBtn = document.getElementById('addProductBtn');
	const closeBtns = document.querySelectorAll('.close-modal, .close-modal-btn');

	let currentImages: string[] = [];

	function renderProducts() {
		const products = $products.get();
		const container = document.getElementById('productsList');
		
		if (!container) return;

		if (products.length === 0) {
			container.innerHTML = '<p>No hay productos registrados.</p>';
			return;
		}

		container.innerHTML = products.map(p => `
			<div class="product-card">
				<img src="${p.images[0] || '/placeholder.png'}" alt="${p.name}" class="product-image">
				<div class="product-details">
					<h3>${p.name}</h3>
					<div class="product-meta">
						<span class="product-price">$${p.price}</span>
						<span>Stock: ${p.stock}</span>
					</div>
				</div>
				<div class="product-actions">
					<button class="btn btn-sm btn-secondary edit-btn" data-id="${p.id}" style="flex: 1;">Editar</button>
					<button class="btn btn-sm btn-danger delete-btn" data-id="${p.id}" style="flex: 1;">Eliminar</button>
				</div>
			</div>
		`).join('');

		// Listeners
		container.querySelectorAll('.edit-btn').forEach(btn => {
			btn.addEventListener('click', (e) => {
				const id = parseInt((e.target as HTMLElement).dataset.id || '0');
				openEditModal(id);
			});
		});

		container.querySelectorAll('.delete-btn').forEach(btn => {
			btn.addEventListener('click', (e) => {
				const id = parseInt((e.target as HTMLElement).dataset.id || '0');
				if (confirm('¿Estás seguro de eliminar este producto?')) {
					deleteProduct(id);
				}
			});
		});
	}

	function openEditModal(id: number) {
		const products = $products.get();
		const product = products.find(p => p.id === id);
		if (!product) return;

		(document.getElementById('productId') as HTMLInputElement).value = product.id.toString();
		(document.getElementById('prodName') as HTMLInputElement).value = product.name;
		(document.getElementById('prodPrice') as HTMLInputElement).value = product.price.toString();
		(document.getElementById('prodStock') as HTMLInputElement).value = product.stock.toString();
		
		currentImages = product.images;
		renderImagePreview();
		
		if (modalTitle) modalTitle.textContent = 'Editar Producto';
		productModal?.classList.add('show');
	}

	function renderImagePreview() {
		if (!imagePreview) return;
		imagePreview.innerHTML = currentImages.map(img => `
			<img src="${img}" class="preview-img">
		`).join('');
	}

	// Image handling
	const fileInput = document.getElementById('prodImages') as HTMLInputElement;
	fileInput?.addEventListener('change', async (e) => {
		const files = (e.target as HTMLInputElement).files;
		if (!files) return;

		// If adding new images, we append them or replace? 
		// For simplicity, let's append if editing, or just use new ones.
		// Let's just process them and add to currentImages
		
		for (let i = 0; i < files.length; i++) {
			const file = files[i];
			const reader = new FileReader();
			reader.onload = (e) => {
				if (e.target?.result) {
					currentImages.push(e.target.result as string);
					renderImagePreview();
				}
			};
			reader.readAsDataURL(file);
		}
	});

	// Form Submit
	productForm?.addEventListener('submit', (e) => {
		e.preventDefault();
		
		const formData = new FormData(productForm);
		const id = formData.get('id') ? parseInt(formData.get('id') as string) : null;
		
		const productData = {
			name: formData.get('name') as string,
			price: parseFloat(formData.get('price') as string),
			stock: parseInt(formData.get('stock') as string),
			images: currentImages.length > 0 ? currentImages : ['/placeholder.png'] // Default image if none
		};

		if (id) {
			updateProduct({ ...productData, id });
		} else {
			addProduct(productData);
		}

		productModal?.classList.remove('show');
		productForm.reset();
		currentImages = [];
		renderImagePreview();
	});

	// Modal controls
	addProductBtn?.addEventListener('click', () => {
		productForm.reset();
		(document.getElementById('productId') as HTMLInputElement).value = '';
		currentImages = [];
		renderImagePreview();
		if (modalTitle) modalTitle.textContent = 'Nuevo Producto';
		productModal?.classList.add('show');
	});

	closeBtns.forEach(btn => {
		btn.addEventListener('click', () => {
			productModal?.classList.remove('show');
		});
	});

	// Init
	$products.subscribe(renderProducts);
	renderProducts();

	window.addEventListener('viewChange', (e: Event) => {
		const customEvent = e as CustomEvent;
		if (customEvent.detail.viewId === 'productos') {
			renderProducts();
		}
	});
</script>
