<div id="nuevaSolicitudView" class="view active">
	<div class="catalog-header">
		<h2>Cat√°logo de Productos</h2>
		<button id="cartBtn" class="btn btn-primary">
			üõí Ver Carrito (<span id="cartCount">0</span>)
		</button>
	</div>

	<div id="catalogGrid" class="catalog-grid">
		<!-- Products will be rendered here -->
	</div>
</div>

<!-- Checkout Modal -->
<div id="checkoutModal" class="modal">
	<div class="modal-content">
		<div class="modal-header">
			<h2>Finalizar Pedido</h2>
			<span class="close-modal">&times;</span>
		</div>
		<div class="modal-body">
			<form id="checkoutForm">
				<!-- Step 1: Basic Info & Cart -->
				<div id="checkoutStep1">
					<div id="cartSummary" class="cart-summary"></div>
					
					<h3>Datos del Cliente</h3>
					<div class="form-row">
						<div class="form-group">
							<label for="clientName">Nombre del Cliente*</label>
							<input type="text" id="clientName" name="clientName" required />
						</div>
						<div class="form-group">
							<label for="clientPhone">Tel√©fono*</label>
							<input type="tel" id="clientPhone" name="clientPhone" required />
						</div>
					</div>
					<div class="form-group">
						<label for="clientEmail">Correo Electr√≥nico*</label>
						<input type="email" id="clientEmail" name="clientEmail" required />
					</div>

					<div class="modal-footer">
						<button type="button" class="btn btn-secondary close-modal-btn">Cancelar</button>
						<button type="button" id="goToStep2Btn" class="btn btn-primary">Continuar a Facturaci√≥n</button>
					</div>
				</div>

				<!-- Step 2: Billing Address -->
				<div id="checkoutStep2" style="display: none;">
					<h3>Direcci√≥n de Facturaci√≥n</h3>
					<div class="form-group">
						<label for="billingAddress">Direcci√≥n*</label>
						<input type="text" id="billingAddress" name="billingAddress" required />
					</div>
					<div class="form-row">
						<div class="form-group">
							<label for="billingCity">Ciudad*</label>
							<input type="text" id="billingCity" name="billingCity" required />
						</div>
						<div class="form-group">
							<label for="billingZip">C√≥digo Postal*</label>
							<input type="text" id="billingZip" name="billingZip" required />
						</div>
					</div>

					<div class="modal-footer">
						<button type="button" id="backToStep1Btn" class="btn btn-secondary">Volver</button>
						<button type="submit" class="btn btn-success">Confirmar Pedido</button>
					</div>
				</div>
			</form>
		</div>
	</div>
</div>

<style is:global>
	#nuevaSolicitudView .catalog-header {
		display: flex;
		justify-content: space-between;
		align-items: center;
		margin-bottom: 2rem;
	}

	#nuevaSolicitudView .catalog-grid {
		display: grid;
		grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
		gap: 2rem;
		padding: 1rem;
	}

	#nuevaSolicitudView .product-card {
		background: white;
		border-radius: 12px;
		padding: 1.5rem;
		box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
		transition: transform 0.3s ease, box-shadow 0.3s ease;
		display: flex;
		flex-direction: column;
		border: 1px solid var(--gray-200);
	}

	#nuevaSolicitudView .product-card:hover {
		transform: translateY(-5px);
		box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
	}

	/* Carousel Styles */
	#nuevaSolicitudView .carousel {
		position: relative;
		width: 100%;
		height: 250px;
		margin-bottom: 1.5rem;
		border-radius: 8px;
		overflow: hidden;
		background: #fff;
		border: 1px solid var(--gray-100);
	}

	#nuevaSolicitudView .carousel-inner {
		width: 100%;
		height: 100%;
		position: relative;
	}

	#nuevaSolicitudView .carousel-item {
		position: absolute;
		top: 0;
		left: 0;
		width: 100%;
		height: 100%;
		opacity: 0;
		transition: opacity 0.4s ease-in-out;
		display: flex;
		align-items: center;
		justify-content: center;
		padding: 1rem;
		background: white;
	}

	#nuevaSolicitudView .carousel-item.active {
		opacity: 1;
		z-index: 1;
	}

	#nuevaSolicitudView .carousel-item img {
		width: 100%;
		height: 100%;
		object-fit: contain;
	}

	#nuevaSolicitudView .carousel-control {
		position: absolute;
		top: 50%;
		transform: translateY(-50%);
		background: rgba(255, 255, 255, 0.8);
		color: var(--gray-800);
		border: 1px solid var(--gray-200);
		width: 36px;
		height: 36px;
		border-radius: 50%;
		display: flex;
		align-items: center;
		justify-content: center;
		cursor: pointer;
		z-index: 2;
		transition: all 0.2s;
		box-shadow: 0 2px 4px rgba(0,0,0,0.1);
		font-size: 1.2rem;
		opacity: 0;
	}

	#nuevaSolicitudView .carousel:hover .carousel-control {
		opacity: 1;
	}

	#nuevaSolicitudView .carousel-control:hover {
		background: var(--primary-color);
		color: white;
		border-color: var(--primary-color);
	}

	#nuevaSolicitudView .carousel-control.prev {
		left: 10px;
	}

	#nuevaSolicitudView .carousel-control.next {
		right: 10px;
	}

	#nuevaSolicitudView .product-info {
		display: flex;
		flex-direction: column;
		gap: 0.5rem;
	}

	#nuevaSolicitudView .product-info h3 {
		font-size: 1.25rem;
		font-weight: 600;
		color: var(--gray-900);
		margin: 0;
	}

	#nuevaSolicitudView .product-price {
		font-size: 1.5rem;
		font-weight: 700;
		color: var(--primary-color);
	}

	#nuevaSolicitudView .product-stock {
		font-size: 0.875rem;
		color: var(--gray-500);
		margin-bottom: 0.5rem;
	}

	#nuevaSolicitudView .quantity-control {
		display: flex;
		align-items: center;
		gap: 0.5rem;
		margin-bottom: 1rem;
	}

	#nuevaSolicitudView .quantity-input {
		width: 80px;
		padding: 0.5rem;
		border: 1px solid var(--gray-300);
		border-radius: 6px;
		text-align: center;
		font-size: 1rem;
	}

	#nuevaSolicitudView .add-to-cart-btn {
		width: 100%;
		padding: 0.75rem;
		font-weight: 600;
		display: flex;
		align-items: center;
		justify-content: center;
		gap: 0.5rem;
	}

	/* Modal Styles need to be global too if not already */
	#checkoutModal .cart-summary {
		background: var(--gray-50);
		padding: 1rem;
		border-radius: 0.5rem;
		margin-bottom: 2rem;
		max-height: 300px;
		overflow-y: auto;
	}

	#checkoutModal .cart-item {
		display: flex;
		justify-content: space-between;
		align-items: center;
		padding: 1rem 0;
		border-bottom: 1px solid var(--gray-200);
		gap: 1rem;
	}

	#checkoutModal .cart-item-info {
		flex: 1;
		display: flex;
		flex-direction: column;
	}

	#checkoutModal .cart-item-name {
		font-weight: 600;
		color: var(--gray-800);
	}

	#checkoutModal .cart-item-price {
		font-size: 0.9rem;
		color: var(--gray-500);
	}

	#checkoutModal .cart-item-controls {
		display: flex;
		align-items: center;
		gap: 0.5rem;
	}

	#checkoutModal .btn-control {
		width: 28px;
		height: 28px;
		border-radius: 4px;
		border: 1px solid var(--gray-300);
		background: white;
		display: flex;
		align-items: center;
		justify-content: center;
		cursor: pointer;
		transition: all 0.2s;
	}

	#checkoutModal .btn-control:hover {
		background: var(--gray-100);
		border-color: var(--gray-400);
	}

	#checkoutModal .btn-control.remove-btn {
		color: #dc2626;
		border-color: #fecaca;
		background: #fef2f2;
		margin-left: 0.5rem;
	}

	#checkoutModal .btn-control.remove-btn:hover {
		background: #fee2e2;
		border-color: #fca5a5;
	}

	#checkoutModal .cart-item-quantity {
		font-weight: 600;
		min-width: 20px;
		text-align: center;
	}

	#checkoutModal .cart-item-subtotal {
		font-weight: 700;
		color: var(--primary-color);
		min-width: 80px;
		text-align: right;
	}

	#checkoutModal .cart-total {
		margin-top: 1rem;
		text-align: right;
		font-weight: 700;
		font-size: 1.2rem;
		padding-top: 1rem;
		border-top: 2px solid var(--gray-200);
	}

	/* Toast Styles */
	.toast {
		position: fixed;
		bottom: 20px;
		right: 20px;
		background: #10b981;
		color: white;
		padding: 1rem 2rem;
		border-radius: 0.5rem;
		box-shadow: 0 4px 12px rgba(0,0,0,0.15);
		transform: translateY(100px);
		opacity: 0;
		transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
		z-index: 2000;
		font-weight: 500;
	}

	.toast.show {
		transform: translateY(0);
		opacity: 1;
	}

	.toast.error {
		background: #ef4444;
	}

	/* Cart Bump Animation */
	@keyframes bump {
		0% { transform: scale(1); }
		50% { transform: scale(1.2); }
		100% { transform: scale(1); }
	}

	.bump {
		animation: bump 0.3s ease-out;
	}
</style>

<script>
	import { $currentUser, createSolicitud } from '../../stores/appStore';
	import { PRODUCTS } from '../../stores/products';

	// State
	let cart: Array<{ product: typeof PRODUCTS[0], quantity: number }> = [];

	// DOM Elements
	const catalogGrid = document.getElementById('catalogGrid');
	const cartBtn = document.getElementById('cartBtn');
	const cartCount = document.getElementById('cartCount');
	const checkoutModal = document.getElementById('checkoutModal');
	const cartSummary = document.getElementById('cartSummary');
	const checkoutForm = document.getElementById('checkoutForm') as HTMLFormElement;
	const closeModalBtns = document.querySelectorAll('.close-modal, .close-modal-btn');
	
	// Steps Elements
	const checkoutStep1 = document.getElementById('checkoutStep1');
	const checkoutStep2 = document.getElementById('checkoutStep2');
	const goToStep2Btn = document.getElementById('goToStep2Btn');
	const backToStep1Btn = document.getElementById('backToStep1Btn');

	// Render Catalog
	function renderCatalog() {
		if (!catalogGrid) return;
		
		catalogGrid.innerHTML = PRODUCTS.map(product => `
			<div class="product-card">
				<div class="carousel" id="carousel-${product.id}">
					<div class="carousel-inner">
						${product.images.map((img, i) => `
							<div class="carousel-item ${i === 0 ? 'active' : ''}">
								<img src="${img}" alt="${product.name}">
							</div>
						`).join('')}
					</div>
					${product.images.length > 1 ? `
						<button class="carousel-control prev" data-id="${product.id}">‚ùÆ</button>
						<button class="carousel-control next" data-id="${product.id}">‚ùØ</button>
					` : ''}
				</div>
				<div class="product-info">
					<h3>${product.name}</h3>
					<div class="product-price">$${product.price}</div>
					<div class="product-stock">Stock: ${product.stock}</div>
					<div class="form-group" style="margin-bottom: 0.5rem;">
						<input type="number" min="1" max="${product.stock}" value="1" class="quantity-input" id="qty-${product.id}" style="width: 100%;">
					</div>
					<button class="btn btn-primary add-to-cart-btn" data-id="${product.id}">
						Agregar al Carrito
					</button>
				</div>
			</div>
		`).join('');

		// Add event listeners
		catalogGrid.querySelectorAll('.add-to-cart-btn').forEach(btn => {
			btn.addEventListener('click', (e) => {
				const target = e.target as HTMLButtonElement;
				const id = parseInt(target.dataset.id || '0');
				const qtyInput = document.getElementById(`qty-${id}`) as HTMLInputElement;
				const quantity = parseInt(qtyInput.value);
				
				addToCart(id, quantity);
			});
		});

		// Carousel listeners
		catalogGrid.querySelectorAll('.carousel-control').forEach(btn => {
			btn.addEventListener('click', (e) => {
				const target = e.target as HTMLButtonElement;
				const id = target.dataset.id;
				const carousel = document.getElementById(`carousel-${id}`);
				if (!carousel) return;

				const items = carousel.querySelectorAll('.carousel-item');
				let activeIndex = Array.from(items).findIndex(item => item.classList.contains('active'));
				
				items[activeIndex].classList.remove('active');

				if (target.classList.contains('next')) {
					activeIndex = (activeIndex + 1) % items.length;
				} else {
					activeIndex = (activeIndex - 1 + items.length) % items.length;
				}

				items[activeIndex].classList.add('active');
			});
		});
	}

	// Toast Logic
	function showToast(message: string, type: 'success' | 'error' = 'success') {
		let toast = document.getElementById('toast');
		if (!toast) {
			toast = document.createElement('div');
			toast.id = 'toast';
			document.body.appendChild(toast);
		}
		
		toast.textContent = message;
		toast.className = `toast show ${type}`;
		
		setTimeout(() => {
			toast?.classList.remove('show');
		}, 3000);
	}

	// Cart Logic
	function addToCart(productId: number, quantity: number) {
		const product = PRODUCTS.find(p => p.id === productId);
		if (!product) return;

		if (quantity > product.stock) {
			showToast('No hay suficiente stock', 'error');
			return;
		}

		const existingItem = cart.find(item => item.product.id === productId);
		if (existingItem) {
			if (existingItem.quantity + quantity > product.stock) {
				showToast('No hay suficiente stock para agregar m√°s', 'error');
				return;
			}
			existingItem.quantity += quantity;
		} else {
			cart.push({ product, quantity });
		}

		updateCartUI();
		showToast('Producto agregado al carrito');
		
		// Animate cart button
		const cartBtn = document.getElementById('cartBtn');
		cartBtn?.classList.add('bump');
		setTimeout(() => cartBtn?.classList.remove('bump'), 300);
	}

	function updateCartUI() {
		if (cartCount) {
			cartCount.textContent = cart.reduce((acc, item) => acc + item.quantity, 0).toString();
		}
		// If modal is open, re-render summary
		if (checkoutModal?.classList.contains('show')) {
			renderCartSummary();
		}
	}

	function renderCartSummary() {
		if (!cartSummary) return;

		if (cart.length === 0) {
			cartSummary.innerHTML = `
				<div class="empty-cart-state">
					<div style="font-size: 3rem; margin-bottom: 1rem;">üõí</div>
					<p style="font-weight: 600; color: var(--gray-800);">Tu carrito est√° vac√≠o</p>
					<p style="color: var(--gray-500); font-size: 0.9rem;">¬°Agrega productos del cat√°logo para comenzar!</p>
				</div>
			`;
			// Disable submit button if needed, but form validation handles required fields
			const submitBtn = checkoutForm.querySelector('button[type="submit"]') as HTMLButtonElement;
			if (submitBtn) submitBtn.disabled = true;
			return;
		}

		// Enable submit button
		const submitBtn = checkoutForm.querySelector('button[type="submit"]') as HTMLButtonElement;
		if (submitBtn) submitBtn.disabled = false;

		const total = cart.reduce((acc, item) => acc + (item.product.price * item.quantity), 0);

		cartSummary.innerHTML = `
			<h4>Resumen del Pedido</h4>
			<div class="cart-items-list">
				${cart.map(item => `
					<div class="cart-item" data-id="${item.product.id}">
						<div class="cart-item-info">
							<span class="cart-item-name">${item.product.name}</span>
							<span class="cart-item-price">$${item.product.price} c/u</span>
						</div>
						<div class="cart-item-controls">
							<button type="button" class="btn-control decrease-btn" data-id="${item.product.id}">-</button>
							<span class="cart-item-quantity">${item.quantity}</span>
							<button type="button" class="btn-control increase-btn" data-id="${item.product.id}">+</button>
							<button type="button" class="btn-control remove-btn" data-id="${item.product.id}">üóëÔ∏è</button>
						</div>
						<div class="cart-item-subtotal">
							$${item.product.price * item.quantity}
						</div>
					</div>
				`).join('')}
			</div>
			<div class="cart-total">Total: $${total}</div>
		`;

		// Attach listeners
		cartSummary.querySelectorAll('.decrease-btn').forEach(btn => {
			btn.addEventListener('click', (e) => {
				const id = parseInt((e.target as HTMLElement).dataset.id || '0');
				updateItemQuantity(id, -1);
			});
		});

		cartSummary.querySelectorAll('.increase-btn').forEach(btn => {
			btn.addEventListener('click', (e) => {
				const id = parseInt((e.target as HTMLElement).dataset.id || '0');
				updateItemQuantity(id, 1);
			});
		});

		cartSummary.querySelectorAll('.remove-btn').forEach(btn => {
			btn.addEventListener('click', (e) => {
				const id = parseInt((e.target as HTMLElement).dataset.id || '0');
				removeFromCart(id);
			});
		});
	}

	function updateItemQuantity(productId: number, change: number) {
		const itemIndex = cart.findIndex(item => item.product.id === productId);
		if (itemIndex === -1) return;

		const item = cart[itemIndex];
		const newQuantity = item.quantity + change;

		if (newQuantity <= 0) {
			removeFromCart(productId);
			return;
		}

		if (newQuantity > item.product.stock) {
			showToast('No hay m√°s stock disponible', 'error');
			return;
		}

		item.quantity = newQuantity;
		updateCartUI();
	}

	function removeFromCart(productId: number) {
		cart = cart.filter(item => item.product.id !== productId);
		updateCartUI();
		// Don't close modal on empty, just re-render
		if (cart.length === 0) {
			renderCartSummary();
		}
	}

	// Step Navigation
	goToStep2Btn?.addEventListener('click', () => {
		// Validate Step 1
		const name = (document.getElementById('clientName') as HTMLInputElement).value;
		const phone = (document.getElementById('clientPhone') as HTMLInputElement).value;
		const email = (document.getElementById('clientEmail') as HTMLInputElement).value;

		if (!name || !phone || !email) {
			showToast('Por favor complete los datos del cliente', 'error');
			return;
		}

		checkoutStep1!.style.display = 'none';
		checkoutStep2!.style.display = 'block';
	});

	backToStep1Btn?.addEventListener('click', () => {
		checkoutStep2!.style.display = 'none';
		checkoutStep1!.style.display = 'block';
	});

	// Modal Logic
	function prefillClientData() {
		const currentUser = $currentUser.get();
		if (currentUser) {
			const nameInput = document.getElementById('clientName') as HTMLInputElement;
			const phoneInput = document.getElementById('clientPhone') as HTMLInputElement;
			const emailInput = document.getElementById('clientEmail') as HTMLInputElement;

			if (nameInput && !nameInput.value) nameInput.value = currentUser.name || '';
			if (phoneInput && !phoneInput.value) phoneInput.value = currentUser.phone || '';
			if (emailInput && !emailInput.value) emailInput.value = currentUser.email || '';
		}
	}

	cartBtn?.addEventListener('click', () => {
		renderCartSummary();
		prefillClientData();
		// Reset steps
		if (checkoutStep1 && checkoutStep2) {
			checkoutStep1.style.display = 'block';
			checkoutStep2.style.display = 'none';
		}
		checkoutModal?.classList.add('show');
	});

	closeModalBtns.forEach(btn => {
		btn.addEventListener('click', () => {
			checkoutModal?.classList.remove('show');
		});
	});

	// Checkout Logic
	checkoutForm.addEventListener('submit', (e) => {
		e.preventDefault();

		const submitBtn = checkoutForm.querySelector('button[type="submit"]') as HTMLButtonElement;
		if (submitBtn.disabled) return;
		submitBtn.disabled = true;

		const currentUser = $currentUser.get();
		if (!currentUser) {
			window.location.href = '/';
			return;
		}

		const formData = new FormData(checkoutForm);
		
		const solicitudData = {
			username: currentUser.username,
			clientName: formData.get('clientName') as string,
			clientPhone: formData.get('clientPhone') as string,
			clientEmail: formData.get('clientEmail') as string,
			billingAddress: {
				address: formData.get('billingAddress') as string,
				city: formData.get('billingCity') as string,
				zip: formData.get('billingZip') as string
			},
			productos: cart.map(item => ({
				productId: item.product.id,
				productName: item.product.name,
				cantidad: item.quantity
			}))
		};

		createSolicitud(solicitudData);

		showToast('¬°Pedido realizado con √©xito!');
		cart = [];
		updateCartUI();
		checkoutForm.reset();
		checkoutModal?.classList.remove('show');
		
		// Re-enable button
		setTimeout(() => {
			submitBtn.disabled = false;
		}, 500);
	});

	// Initial Render
	renderCatalog();
</script>
